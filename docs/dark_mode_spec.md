# ダークモード仕様・動作フロー

## 概要
Zenn Dark+のダークモードは、システムテーマ設定（OSのダーク/ライト）とユーザーのローカルストレージ設定を組み合わせて、ページ表示のダーク/ライトを制御します。

## 優先順位・動作フロー

1. **ページ初期表示時**
    - 「システムのテーマを使用する」がONの場合：
        - OSのテーマ（ダーク/ライト）に従ってページを表示
        - 変更時は即時反映
    - 「システムのテーマを使用する」がOFFの場合：
        - ローカルストレージの値（ユーザーが前回選択したダーク/ライト）を適用

2. **ユーザーがトグルボタンを押した場合**
    - 「システムのテーマを使用する」がOFFなら、ローカルストレージの値と画面表示をトグル
    - ONの場合はシステムテーマに従うため、トグルは無効

3. **他タブやポップアップからの変更**
    - storage.watchで即時反映

## 管理クラスの役割

- **UseSystemThemeSetting**
    - 「システムのテーマを使用する」設定をstorage APIで管理
    - get/set/toggleで状態取得・保存・トグル
    - isSystemDark()でOSのダーク/ライト状態を取得

- **DarkModeSetting**
    - ダークモード有効/無効の状態をstorage APIで管理
    - get/set/toggleで状態取得・保存・トグル

- **DarkModeManager**
    - 現在のダークモード状態を保持し、html要素へのクラス（dark-mode-enabled）付与/削除で見た目を制御
    - initialize/enable/disable/toggleで状態管理

- **ThemeToggleButton**
    - UI上のトグルボタンを生成・管理
    - 状態に応じてSVGアイコンを切り替え

## CSS適用方式
- CSSは常に挿入されており、`html`要素に`dark-mode-enabled`クラスを付与/削除することでダークモードを切り替えます。
- 例外的に一部要素は除外指定あり。

## 備考
- ストレージAPIはWXTの`storage`を利用
- 設定や状態は全て非同期で取得・保存
- ポップアップUIからもシステムテーマ利用設定を変更可能
